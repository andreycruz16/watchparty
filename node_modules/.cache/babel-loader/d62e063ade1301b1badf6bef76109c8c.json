{"ast":null,"code":"import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React from'react';import{Button,Comment,Icon,Input,Popup}from'semantic-ui-react';import'emoji-mart/css/emoji-mart.css';import{Picker}from'emoji-mart';import onClickOutside from'react-onclickoutside';//@ts-ignore\nimport Linkify from'react-linkify';import{SecureLink}from'react-secure-link';import{formatTimestamp,getColorForStringHex,getDefaultPicture}from'../../utils';import{Separator}from'../App/App';import{UserMenu}from'../UserMenu/UserMenu';import classes from'./Chat.module.css';import{CSSTransition,SwitchTransition,TransitionGroup}from'react-transition-group';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var reactionEmojis=Array.from('👍🧡😂😯😢😡');export var Chat=/*#__PURE__*/function(_React$Component){_inherits(Chat,_React$Component);var _super=_createSuper(Chat);function Chat(){var _this;_classCallCheck(this,Chat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={chatMsg:'',isNearBottom:true,isPickerOpen:false,reactionMenu:{isOpen:false,selectedMsgId:'',selectedMsgTimestamp:'',yPosition:0,xPosition:0}};_this.messagesRef=/*#__PURE__*/React.createRef();_this.setReactionMenu=function(isOpen,selectedMsgId,selectedMsgTimestamp,yPosition,xPosition){_this.setState({reactionMenu:{isOpen:isOpen,selectedMsgId:selectedMsgId,selectedMsgTimestamp:selectedMsgTimestamp,yPosition:yPosition,xPosition:xPosition}});};_this.handleReactionClick=function(value,id,timestamp){var _msg$reactions;var msg=_this.props.chat.find(function(m){return m.id===id&&m.timestamp===timestamp;});var data={value:value,msgId:id||_this.state.reactionMenu.selectedMsgId,msgTimestamp:timestamp||_this.state.reactionMenu.selectedMsgTimestamp};if(msg!==null&&msg!==void 0&&(_msg$reactions=msg.reactions)!==null&&_msg$reactions!==void 0&&_msg$reactions[value].includes(_this.props.socket.id)){_this.props.socket.emit('CMD:removeReaction',data);}else{_this.props.socket.emit('CMD:addReaction',data);}};_this.updateChatMsg=function(_e,data){// console.log(e.target.selectionStart);\n_this.setState({chatMsg:data.value});};_this.sendChatMsg=function(){if(!_this.state.chatMsg){return;}if(_this.chatTooLong()){return;}_this.setState({chatMsg:''});_this.props.socket.emit('CMD:chat',_this.state.chatMsg);};_this.chatTooLong=function(){var _this$state$chatMsg;return Boolean(((_this$state$chatMsg=_this.state.chatMsg)===null||_this$state$chatMsg===void 0?void 0:_this$state$chatMsg.length)>10000);};_this.onScroll=function(){_this.setState({isNearBottom:_this.isChatNearBottom()});};_this.isChatNearBottom=function(){return _this.messagesRef.current&&_this.messagesRef.current.scrollHeight-_this.messagesRef.current.scrollTop-_this.messagesRef.current.offsetHeight<100;};_this.scrollToBottom=function(){if(_this.messagesRef.current){_this.messagesRef.current.scrollTop=_this.messagesRef.current.scrollHeight;}};_this.formatMessage=function(cmd,msg){if(cmd==='host'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"changed the video to \",/*#__PURE__*/_jsx(\"span\",{style:{textTransform:'initial'},children:_this.props.getMediaDisplayName(msg)})]});}else if(cmd==='playlistAdd'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"added to the playlist: \",/*#__PURE__*/_jsx(\"span\",{style:{textTransform:'initial'},children:_this.props.getMediaDisplayName(msg)})]});}else if(cmd==='seek'){return\"jumped to \".concat(formatTimestamp(msg));}else if(cmd==='play'){return\"started the video at \".concat(formatTimestamp(msg));}else if(cmd==='pause'){return\"paused the video at \".concat(formatTimestamp(msg));}else if(cmd==='lock'){return\"locked the room\";}else if(cmd==='unlock'){return'unlocked the room';}else if(cmd==='vBrowserTimeout'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"The VBrowser shut down automatically.\",/*#__PURE__*/_jsx(\"br\",{}),\"Subscribe for longer sessions.\"]});}else if(cmd==='vBrowserAlmostTimeout'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"The VBrowser will shut down soon.\",/*#__PURE__*/_jsx(\"br\",{}),\"Subscribe for longer sessions.\"]});}return cmd;};_this.addEmoji=function(emoji){_this.setState({chatMsg:_this.state.chatMsg+emoji.native});};return _this;}_createClass(Chat,[{key:\"componentDidMount\",value:function componentDidMount(){var _this$messagesRef$cur;this.scrollToBottom();(_this$messagesRef$cur=this.messagesRef.current)===null||_this$messagesRef$cur===void 0?void 0:_this$messagesRef$cur.addEventListener('scroll',this.onScroll);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(this.props.scrollTimestamp!==prevProps.scrollTimestamp){if(prevProps.scrollTimestamp===0||this.state.isNearBottom){this.scrollToBottom();}}if(this.props.hide!==prevProps.hide){this.scrollToBottom();}}},{key:\"render\",value:function render(){var _this2=this;return/*#__PURE__*/_jsxs(\"div\",{className:this.props.className,style:{display:this.props.hide?'none':'flex',flexDirection:'column',flexGrow:1,minHeight:0,marginTop:0,marginBottom:0,padding:'8px'},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chatContainer\",ref:this.messagesRef,style:{position:'relative',paddingTop:13},children:[/*#__PURE__*/_jsx(Comment.Group,{children:this.props.chat.map(function(msg){return/*#__PURE__*/_jsx(ChatMessage,{className:msg.id===_this2.state.reactionMenu.selectedMsgId&&msg.timestamp===_this2.state.reactionMenu.selectedMsgTimestamp?classes.selected:'',message:msg,pictureMap:_this2.props.pictureMap,nameMap:_this2.props.nameMap,formatMessage:_this2.formatMessage,owner:_this2.props.owner,user:_this2.props.user,socket:_this2.props.socket,isChatDisabled:_this2.props.isChatDisabled,setReactionMenu:_this2.setReactionMenu,handleReactionClick:_this2.handleReactionClick},msg.timestamp+msg.id);})}),!this.state.isNearBottom&&/*#__PURE__*/_jsx(Button,{size:\"tiny\",onClick:this.scrollToBottom,style:{position:'sticky',bottom:0,display:'block',margin:'0 auto'},children:\"Jump to bottom\"})]}),/*#__PURE__*/_jsx(Separator,{}),this.state.isPickerOpen&&/*#__PURE__*/_jsx(PickerMenu,{addEmoji:this.addEmoji,closeMenu:function closeMenu(){return _this2.setState({isPickerOpen:false});}}),/*#__PURE__*/_jsx(CSSTransition,{in:this.state.reactionMenu.isOpen,timeout:300,classNames:{enter:classes['reactionMenu-enter'],enterActive:classes['reactionMenu-enter-active'],exit:classes['reactionMenu-exit'],exitActive:classes['reactionMenu-exit-active']},unmountOnExit:true,children:/*#__PURE__*/_jsx(ReactionMenu,{handleReactionClick:this.handleReactionClick,closeMenu:function closeMenu(){return _this2.setReactionMenu(false);},yPosition:this.state.reactionMenu.yPosition,xPosition:this.state.reactionMenu.xPosition})}),/*#__PURE__*/_jsxs(Input,{inverted:true,fluid:true,onKeyPress:function onKeyPress(e){return e.key==='Enter'&&_this2.sendChatMsg();},onChange:this.updateChatMsg,value:this.state.chatMsg,error:this.chatTooLong(),icon:true,disabled:this.props.isChatDisabled,placeholder:this.props.isChatDisabled?'The chat was disabled by the room owner.':'Enter a message...',children:[/*#__PURE__*/_jsx(\"input\",{}),/*#__PURE__*/_jsx(Icon// style={{ right: '40px' }}\n,{onClick:function onClick(){return _this2.setState({isPickerOpen:true});},name:'',inverted:true,circular:true,link:true,disabled:this.props.isChatDisabled,style:{opacity:1},children:/*#__PURE__*/_jsx(\"span\",{role:\"img\",\"aria-label\":\"Emoji\",children:\"\\uD83D\\uDE00\"})})]})]});}}]);return Chat;}(React.Component);var ChatMessage=function ChatMessage(_ref){var message=_ref.message,nameMap=_ref.nameMap,pictureMap=_ref.pictureMap,formatMessage=_ref.formatMessage,user=_ref.user,socket=_ref.socket,owner=_ref.owner,isChatDisabled=_ref.isChatDisabled,setReactionMenu=_ref.setReactionMenu,handleReactionClick=_ref.handleReactionClick,className=_ref.className;var id=message.id,timestamp=message.timestamp,cmd=message.cmd,msg=message.msg,system=message.system,isSub=message.isSub,reactions=message.reactions;var spellFull=5;// the number of people whose names should be written out in full in the reaction popup\nreturn/*#__PURE__*/_jsxs(Comment,{className:\"\".concat(classes.comment,\" \").concat(className),children:[id?/*#__PURE__*/_jsx(Popup,{content:\"WatchParty Plus subscriber\",disabled:!isSub,trigger:/*#__PURE__*/_jsx(Comment.Avatar,{className:isSub?classes.subscriber:'',src:pictureMap[id]||getDefaultPicture(nameMap[id],getColorForStringHex(id))})}):null,/*#__PURE__*/_jsxs(Comment.Content,{children:[/*#__PURE__*/_jsx(UserMenu,{displayName:nameMap[id]||id,user:user,timestamp:timestamp,socket:socket,userToManage:id,isChatMessage:true,disabled:!Boolean(owner&&owner===(user===null||user===void 0?void 0:user.uid)),trigger:/*#__PURE__*/_jsxs(Comment.Author,{as:\"a\",className:\"light\",children:[Boolean(system)&&'System',nameMap[id]||id]})}),/*#__PURE__*/_jsx(Comment.Metadata,{className:\"dark\",children:/*#__PURE__*/_jsx(\"div\",{children:new Date(timestamp).toLocaleTimeString()})}),/*#__PURE__*/_jsx(Comment.Text,{className:\"light system\",children:cmd&&formatMessage(cmd,msg)}),/*#__PURE__*/_jsx(Linkify,{componentDecorator:function componentDecorator(decoratedHref,decoratedText,key){return/*#__PURE__*/_jsx(SecureLink,{href:decoratedHref,children:decoratedText},key);},children:/*#__PURE__*/_jsx(Comment.Text,{className:\"light\",children:!cmd&&msg})}),/*#__PURE__*/_jsx(\"div\",{className:classes.commentMenu,children:/*#__PURE__*/_jsx(Icon,{onClick:function onClick(e){var viewportOffset=e.target.getBoundingClientRect();setReactionMenu(true,id,timestamp,viewportOffset.top,viewportOffset.right);},name:'',inverted:true,link:true,disabled:isChatDisabled,style:{opacity:1,display:'flex',justifyContent:'center',alignItems:'center',padding:10,margin:0},children:/*#__PURE__*/_jsx(\"span\",{role:\"img\",\"aria-label\":\"React\",style:{margin:0,fontSize:18},children:\"\\uD83D\\uDE00\"})})}),/*#__PURE__*/_jsx(TransitionGroup,{children:Object.keys(reactions!==null&&reactions!==void 0?reactions:[]).map(function(key){return reactions!==null&&reactions!==void 0&&reactions[key].length?/*#__PURE__*/_jsx(CSSTransition,{timeout:200,classNames:{enter:classes['reaction-enter'],enterActive:classes['reaction-enter-active'],exit:classes['reaction-exit'],exitActive:classes['reaction-exit-active']},unmountOnExit:true,children:/*#__PURE__*/_jsx(Popup,{content:\"\".concat(reactions[key].slice(0,spellFull).map(function(id){return nameMap[id]||'Unknown';}).concat(reactions[key].length>spellFull?[\"\".concat(reactions[key].length-spellFull,\" more\")]:[]).reduce(function(text,value,i,array){return text+(i<array.length-1?', ':' and ')+value;}),\" reacted.\"),offset:[0,6],trigger:/*#__PURE__*/_jsxs(\"div\",{className:classes.reactionContainer,onClick:function onClick(){return handleReactionClick(key,message.id,message.timestamp);},children:[/*#__PURE__*/_jsx(\"span\",{style:{fontSize:17,position:'relative',bottom:1},children:key}),/*#__PURE__*/_jsx(SwitchTransition,{children:/*#__PURE__*/_jsx(CSSTransition,{classNames:{enter:classes['reactionCounter-enter'],enterActive:classes['reactionCounter-enter-active'],exit:classes['reactionCounter-exit'],exitActive:classes['reactionCounter-exit-active']},addEndListener:function addEndListener(node,done){return node.addEventListener('transitionend',done,false);},unmountOnExit:true,children:/*#__PURE__*/_jsx(\"span\",{className:classes.reactionCounter,style:{color:'rgba(255, 255, 255, 0.85)',marginLeft:3},children:reactions[key].length})},key+'-'+reactions[key].length)})]})})},key):null;})})]})]});};var PickerMenuInner=/*#__PURE__*/function(_React$Component2){_inherits(PickerMenuInner,_React$Component2);var _super2=_createSuper(PickerMenuInner);function PickerMenuInner(){var _this3;_classCallCheck(this,PickerMenuInner);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}_this3=_super2.call.apply(_super2,[this].concat(args));_this3.handleClickOutside=function(){_this3.props.closeMenu();};return _this3;}_createClass(PickerMenuInner,[{key:\"render\",value:function render(){return/*#__PURE__*/_jsx(\"div\",{style:{position:'absolute',bottom:'60px'},children:/*#__PURE__*/_jsx(Picker,{set:\"google\",sheetSize:64,theme:\"dark\",showPreview:false,showSkinTones:false,onSelect:this.props.addEmoji})});}}]);return PickerMenuInner;}(React.Component);var PickerMenu=onClickOutside(PickerMenuInner);var ReactionMenuInner=/*#__PURE__*/function(_React$Component3){_inherits(ReactionMenuInner,_React$Component3);var _super3=_createSuper(ReactionMenuInner);function ReactionMenuInner(){var _this4;_classCallCheck(this,ReactionMenuInner);for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}_this4=_super3.call.apply(_super3,[this].concat(args));_this4.state={containerWidth:0};_this4.handleClickOutside=function(){_this4.props.closeMenu();};_this4.containerRef=/*#__PURE__*/React.createRef();return _this4;}_createClass(ReactionMenuInner,[{key:\"componentDidMount\",value:function componentDidMount(){var _this$containerRef$cu;this.setState({containerWidth:(_this$containerRef$cu=this.containerRef.current)===null||_this$containerRef$cu===void 0?void 0:_this$containerRef$cu.offsetWidth});}},{key:\"render\",value:function render(){var _this5=this;return/*#__PURE__*/_jsx(\"div\",{ref:this.containerRef,className:classes.reactionMenuContainer,style:{top:this.props.yPosition-9,left:this.props.xPosition-this.state.containerWidth-35},children:reactionEmojis.map(function(reaction){return/*#__PURE__*/_jsx(\"div\",{onClick:function onClick(){_this5.props.handleReactionClick(reaction);_this5.props.closeMenu();},style:{cursor:'pointer'},children:reaction});})});}}]);return ReactionMenuInner;}(React.Component);var ReactionMenu=onClickOutside(ReactionMenuInner);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/Chat/Chat.tsx"],"names":["React","Button","Comment","Icon","Input","Popup","Picker","onClickOutside","Linkify","SecureLink","formatTimestamp","getColorForStringHex","getDefaultPicture","Separator","UserMenu","classes","CSSTransition","SwitchTransition","TransitionGroup","reactionEmojis","Array","from","Chat","state","chatMsg","isNearBottom","isPickerOpen","reactionMenu","isOpen","selectedMsgId","selectedMsgTimestamp","yPosition","xPosition","messagesRef","createRef","setReactionMenu","setState","handleReactionClick","value","id","timestamp","msg","props","chat","find","m","data","msgId","msgTimestamp","reactions","includes","socket","emit","updateChatMsg","_e","sendChatMsg","chatTooLong","Boolean","length","onScroll","isChatNearBottom","current","scrollHeight","scrollTop","offsetHeight","scrollToBottom","formatMessage","cmd","textTransform","getMediaDisplayName","addEmoji","emoji","native","addEventListener","prevProps","scrollTimestamp","hide","className","display","flexDirection","flexGrow","minHeight","marginTop","marginBottom","padding","position","paddingTop","map","selected","pictureMap","nameMap","owner","user","isChatDisabled","bottom","margin","enter","enterActive","exit","exitActive","e","key","opacity","Component","ChatMessage","message","system","isSub","spellFull","comment","subscriber","uid","Date","toLocaleTimeString","decoratedHref","decoratedText","commentMenu","viewportOffset","target","getBoundingClientRect","top","right","justifyContent","alignItems","fontSize","Object","keys","slice","concat","reduce","text","i","array","reactionContainer","node","done","reactionCounter","color","marginLeft","PickerMenuInner","handleClickOutside","closeMenu","PickerMenu","ReactionMenuInner","containerWidth","containerRef","offsetWidth","reactionMenuContainer","left","reaction","cursor","ReactionMenu"],"mappings":"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","sourcesContent":["import React, { RefObject } from 'react';\nimport { Button, Comment, Icon, Input, Popup } from 'semantic-ui-react';\nimport 'emoji-mart/css/emoji-mart.css';\nimport { EmojiData, Picker } from 'emoji-mart';\nimport onClickOutside from 'react-onclickoutside';\n//@ts-ignore\nimport Linkify from 'react-linkify';\nimport { SecureLink } from 'react-secure-link';\n\nimport {\n  formatTimestamp,\n  getColorForStringHex,\n  getDefaultPicture,\n} from '../../utils';\nimport { Separator } from '../App/App';\nimport { UserMenu } from '../UserMenu/UserMenu';\nimport { Socket } from 'socket.io-client';\nimport firebase from 'firebase/compat/app';\nimport classes from './Chat.module.css';\nimport {\n  CSSTransition,\n  SwitchTransition,\n  TransitionGroup,\n} from 'react-transition-group';\n\nconst reactionEmojis = Array.from('👍🧡😂😯😢😡');\n\ninterface ChatProps {\n  chat: ChatMessage[];\n  nameMap: StringDict;\n  pictureMap: StringDict;\n  socket: Socket;\n  scrollTimestamp: number;\n  className?: string;\n  getMediaDisplayName: Function;\n  hide?: boolean;\n  isChatDisabled?: boolean;\n  user: firebase.User | undefined;\n  owner: string | undefined;\n  ref: RefObject<Chat>;\n}\n\nexport class Chat extends React.Component<ChatProps> {\n  public state = {\n    chatMsg: '',\n    isNearBottom: true,\n    isPickerOpen: false,\n    reactionMenu: {\n      isOpen: false,\n      selectedMsgId: '',\n      selectedMsgTimestamp: '',\n      yPosition: 0,\n      xPosition: 0,\n    },\n  };\n  messagesRef = React.createRef<HTMLDivElement>();\n\n  componentDidMount() {\n    this.scrollToBottom();\n    this.messagesRef.current?.addEventListener('scroll', this.onScroll);\n  }\n\n  componentDidUpdate(prevProps: ChatProps) {\n    if (this.props.scrollTimestamp !== prevProps.scrollTimestamp) {\n      if (prevProps.scrollTimestamp === 0 || this.state.isNearBottom) {\n        this.scrollToBottom();\n      }\n    }\n    if (this.props.hide !== prevProps.hide) {\n      this.scrollToBottom();\n    }\n  }\n\n  setReactionMenu = (\n    isOpen: boolean,\n    selectedMsgId?: string,\n    selectedMsgTimestamp?: string,\n    yPosition?: number,\n    xPosition?: number\n  ) => {\n    this.setState({\n      reactionMenu: {\n        isOpen,\n        selectedMsgId,\n        selectedMsgTimestamp,\n        yPosition,\n        xPosition,\n      },\n    });\n  };\n\n  handleReactionClick = (value: string, id: string, timestamp: string) => {\n    const msg = this.props.chat.find(\n      (m) => m.id === id && m.timestamp === timestamp\n    );\n    const data = {\n      value,\n      msgId: id || this.state.reactionMenu.selectedMsgId,\n      msgTimestamp: timestamp || this.state.reactionMenu.selectedMsgTimestamp,\n    };\n    if (msg?.reactions?.[value].includes(this.props.socket.id)) {\n      this.props.socket.emit('CMD:removeReaction', data);\n    } else {\n      this.props.socket.emit('CMD:addReaction', data);\n    }\n  };\n\n  updateChatMsg = (_e: any, data: { value: string }) => {\n    // console.log(e.target.selectionStart);\n    this.setState({ chatMsg: data.value });\n  };\n\n  sendChatMsg = () => {\n    if (!this.state.chatMsg) {\n      return;\n    }\n    if (this.chatTooLong()) {\n      return;\n    }\n    this.setState({ chatMsg: '' });\n    this.props.socket.emit('CMD:chat', this.state.chatMsg);\n  };\n\n  chatTooLong = () => {\n    return Boolean(this.state.chatMsg?.length > 10000);\n  };\n\n  onScroll = () => {\n    this.setState({ isNearBottom: this.isChatNearBottom() });\n  };\n\n  isChatNearBottom = () => {\n    return (\n      this.messagesRef.current &&\n      this.messagesRef.current.scrollHeight -\n        this.messagesRef.current.scrollTop -\n        this.messagesRef.current.offsetHeight <\n        100\n    );\n  };\n\n  scrollToBottom = () => {\n    if (this.messagesRef.current) {\n      this.messagesRef.current.scrollTop =\n        this.messagesRef.current.scrollHeight;\n    }\n  };\n\n  formatMessage = (cmd: string, msg: string): React.ReactNode | string => {\n    if (cmd === 'host') {\n      return (\n        <React.Fragment>\n          {`changed the video to `}\n          <span style={{ textTransform: 'initial' }}>\n            {this.props.getMediaDisplayName(msg)}\n          </span>\n        </React.Fragment>\n      );\n    } else if (cmd === 'playlistAdd') {\n      return (\n        <React.Fragment>\n          {`added to the playlist: `}\n          <span style={{ textTransform: 'initial' }}>\n            {this.props.getMediaDisplayName(msg)}\n          </span>\n        </React.Fragment>\n      );\n    } else if (cmd === 'seek') {\n      return `jumped to ${formatTimestamp(msg)}`;\n    } else if (cmd === 'play') {\n      return `started the video at ${formatTimestamp(msg)}`;\n    } else if (cmd === 'pause') {\n      return `paused the video at ${formatTimestamp(msg)}`;\n    } else if (cmd === 'lock') {\n      return `locked the room`;\n    } else if (cmd === 'unlock') {\n      return 'unlocked the room';\n    } else if (cmd === 'vBrowserTimeout') {\n      return (\n        <React.Fragment>\n          The VBrowser shut down automatically.\n          <br />\n          Subscribe for longer sessions.\n        </React.Fragment>\n      );\n    } else if (cmd === 'vBrowserAlmostTimeout') {\n      return (\n        <React.Fragment>\n          The VBrowser will shut down soon.\n          <br />\n          Subscribe for longer sessions.\n        </React.Fragment>\n      );\n    }\n    return cmd;\n  };\n\n  addEmoji = (emoji: EmojiData) => {\n    this.setState({ chatMsg: this.state.chatMsg + (emoji as any).native });\n  };\n\n  render() {\n    return (\n      <div\n        className={this.props.className}\n        style={{\n          display: this.props.hide ? 'none' : 'flex',\n          flexDirection: 'column',\n          flexGrow: 1,\n          minHeight: 0,\n          marginTop: 0,\n          marginBottom: 0,\n          padding: '8px',\n        }}\n      >\n        <div\n          className=\"chatContainer\"\n          ref={this.messagesRef}\n          style={{ position: 'relative', paddingTop: 13 }}\n        >\n          <Comment.Group>\n            {this.props.chat.map((msg) => (\n              <ChatMessage\n                key={msg.timestamp + msg.id}\n                className={\n                  msg.id === this.state.reactionMenu.selectedMsgId &&\n                  msg.timestamp === this.state.reactionMenu.selectedMsgTimestamp\n                    ? classes.selected\n                    : ''\n                }\n                message={msg}\n                pictureMap={this.props.pictureMap}\n                nameMap={this.props.nameMap}\n                formatMessage={this.formatMessage}\n                owner={this.props.owner}\n                user={this.props.user}\n                socket={this.props.socket}\n                isChatDisabled={this.props.isChatDisabled}\n                setReactionMenu={this.setReactionMenu}\n                handleReactionClick={this.handleReactionClick}\n              />\n            ))}\n            {/* <div ref={this.messagesEndRef} /> */}\n          </Comment.Group>\n          {!this.state.isNearBottom && (\n            <Button\n              size=\"tiny\"\n              onClick={this.scrollToBottom}\n              style={{\n                position: 'sticky',\n                bottom: 0,\n                display: 'block',\n                margin: '0 auto',\n              }}\n            >\n              Jump to bottom\n            </Button>\n          )}\n        </div>\n        <Separator />\n        {this.state.isPickerOpen && (\n          <PickerMenu\n            addEmoji={this.addEmoji}\n            closeMenu={() => this.setState({ isPickerOpen: false })}\n          />\n        )}\n        <CSSTransition\n          in={this.state.reactionMenu.isOpen}\n          timeout={300}\n          classNames={{\n            enter: classes['reactionMenu-enter'],\n            enterActive: classes['reactionMenu-enter-active'],\n            exit: classes['reactionMenu-exit'],\n            exitActive: classes['reactionMenu-exit-active'],\n          }}\n          unmountOnExit\n        >\n          <ReactionMenu\n            handleReactionClick={this.handleReactionClick}\n            closeMenu={() => this.setReactionMenu(false)}\n            yPosition={this.state.reactionMenu.yPosition}\n            xPosition={this.state.reactionMenu.xPosition}\n          />\n        </CSSTransition>\n        <Input\n          inverted\n          fluid\n          onKeyPress={(e: any) => e.key === 'Enter' && this.sendChatMsg()}\n          onChange={this.updateChatMsg}\n          value={this.state.chatMsg}\n          error={this.chatTooLong()}\n          icon\n          disabled={this.props.isChatDisabled}\n          placeholder={\n            this.props.isChatDisabled\n              ? 'The chat was disabled by the room owner.'\n              : 'Enter a message...'\n          }\n        >\n          <input />\n          <Icon\n            // style={{ right: '40px' }}\n            onClick={() => this.setState({ isPickerOpen: true })}\n            name={'' as any}\n            inverted\n            circular\n            link\n            disabled={this.props.isChatDisabled}\n            style={{ opacity: 1 }}\n          >\n            <span role=\"img\" aria-label=\"Emoji\">\n              😀\n            </span>\n          </Icon>\n          {/* <Icon onClick={this.sendChatMsg} name=\"send\" inverted circular link /> */}\n        </Input>\n      </div>\n    );\n  }\n}\n\nconst ChatMessage = ({\n  message,\n  nameMap,\n  pictureMap,\n  formatMessage,\n  user,\n  socket,\n  owner,\n  isChatDisabled,\n  setReactionMenu,\n  handleReactionClick,\n  className,\n}: {\n  message: ChatMessage;\n  nameMap: StringDict;\n  pictureMap: StringDict;\n  formatMessage: (cmd: string, msg: string) => React.ReactNode;\n  user: firebase.User | undefined;\n  socket: Socket;\n  owner: string | undefined;\n  isChatDisabled: boolean | undefined;\n  setReactionMenu: Function;\n  handleReactionClick: Function;\n  className: string;\n}) => {\n  const { id, timestamp, cmd, msg, system, isSub, reactions } = message;\n  const spellFull = 5; // the number of people whose names should be written out in full in the reaction popup\n  return (\n    <Comment className={`${classes.comment} ${className}`}>\n      {id ? (\n        <Popup\n          content=\"WatchParty Plus subscriber\"\n          disabled={!isSub}\n          trigger={\n            <Comment.Avatar\n              className={isSub ? classes.subscriber : ''}\n              src={\n                pictureMap[id] ||\n                getDefaultPicture(nameMap[id], getColorForStringHex(id))\n              }\n            />\n          }\n        />\n      ) : null}\n      <Comment.Content>\n        <UserMenu\n          displayName={nameMap[id] || id}\n          user={user}\n          timestamp={timestamp}\n          socket={socket}\n          userToManage={id}\n          isChatMessage\n          disabled={!Boolean(owner && owner === user?.uid)}\n          trigger={\n            <Comment.Author as=\"a\" className=\"light\">\n              {Boolean(system) && 'System'}\n              {nameMap[id] || id}\n            </Comment.Author>\n          }\n        />\n        <Comment.Metadata className=\"dark\">\n          <div>{new Date(timestamp).toLocaleTimeString()}</div>\n        </Comment.Metadata>\n        <Comment.Text className=\"light system\">\n          {cmd && formatMessage(cmd, msg)}\n        </Comment.Text>\n        <Linkify\n          componentDecorator={(\n            decoratedHref: string,\n            decoratedText: string,\n            key: string\n          ) => (\n            <SecureLink href={decoratedHref} key={key}>\n              {decoratedText}\n            </SecureLink>\n          )}\n        >\n          <Comment.Text className=\"light\">{!cmd && msg}</Comment.Text>\n        </Linkify>\n        <div className={classes.commentMenu}>\n          <Icon\n            onClick={(e: MouseEvent) => {\n              const viewportOffset = (e.target as any).getBoundingClientRect();\n              setReactionMenu(\n                true,\n                id,\n                timestamp,\n                viewportOffset.top,\n                viewportOffset.right\n              );\n            }}\n            name={'' as any}\n            inverted\n            link\n            disabled={isChatDisabled}\n            style={{\n              opacity: 1,\n              display: 'flex',\n              justifyContent: 'center',\n              alignItems: 'center',\n              padding: 10,\n              margin: 0,\n            }}\n          >\n            <span\n              role=\"img\"\n              aria-label=\"React\"\n              style={{ margin: 0, fontSize: 18 }}\n            >\n              😀\n            </span>\n          </Icon>\n        </div>\n        <TransitionGroup>\n          {Object.keys(reactions ?? []).map((key) =>\n            reactions?.[key].length ? (\n              <CSSTransition\n                key={key}\n                timeout={200}\n                classNames={{\n                  enter: classes['reaction-enter'],\n                  enterActive: classes['reaction-enter-active'],\n                  exit: classes['reaction-exit'],\n                  exitActive: classes['reaction-exit-active'],\n                }}\n                unmountOnExit\n              >\n                <Popup\n                  content={`${reactions[key]\n                    .slice(0, spellFull)\n                    .map((id) => nameMap[id] || 'Unknown')\n                    .concat(\n                      reactions[key].length > spellFull\n                        ? [`${reactions[key].length - spellFull} more`]\n                        : []\n                    )\n                    .reduce(\n                      (text, value, i, array) =>\n                        text + (i < array.length - 1 ? ', ' : ' and ') + value\n                    )} reacted.`}\n                  offset={[0, 6]}\n                  trigger={\n                    <div\n                      className={classes.reactionContainer}\n                      onClick={() =>\n                        handleReactionClick(key, message.id, message.timestamp)\n                      }\n                    >\n                      <span\n                        style={{\n                          fontSize: 17,\n                          position: 'relative',\n                          bottom: 1,\n                        }}\n                      >\n                        {key}\n                      </span>\n                      <SwitchTransition>\n                        <CSSTransition\n                          key={key + '-' + reactions[key].length}\n                          classNames={{\n                            enter: classes['reactionCounter-enter'],\n                            enterActive:\n                              classes['reactionCounter-enter-active'],\n                            exit: classes['reactionCounter-exit'],\n                            exitActive: classes['reactionCounter-exit-active'],\n                          }}\n                          addEndListener={(node, done) =>\n                            node.addEventListener('transitionend', done, false)\n                          }\n                          unmountOnExit\n                        >\n                          <span\n                            className={classes.reactionCounter}\n                            style={{\n                              color: 'rgba(255, 255, 255, 0.85)',\n                              marginLeft: 3,\n                            }}\n                          >\n                            {reactions[key].length}\n                          </span>\n                        </CSSTransition>\n                      </SwitchTransition>\n                    </div>\n                  }\n                />\n              </CSSTransition>\n            ) : null\n          )}\n        </TransitionGroup>\n      </Comment.Content>\n    </Comment>\n  );\n};\n\nclass PickerMenuInner extends React.Component<{\n  addEmoji: (emoji: EmojiData) => void;\n  closeMenu: Function;\n}> {\n  handleClickOutside = () => {\n    this.props.closeMenu();\n  };\n  render() {\n    return (\n      <div style={{ position: 'absolute', bottom: '60px' }}>\n        <Picker\n          set=\"google\"\n          sheetSize={64}\n          theme=\"dark\"\n          showPreview={false}\n          showSkinTones={false}\n          onSelect={this.props.addEmoji}\n        />\n      </div>\n    );\n  }\n}\n\nconst PickerMenu = onClickOutside(PickerMenuInner);\n\nclass ReactionMenuInner extends React.Component<{\n  handleReactionClick: Function;\n  closeMenu: Function;\n  yPosition: number;\n  xPosition: number;\n}> {\n  state = {\n    containerWidth: 0,\n  };\n  handleClickOutside = () => {\n    this.props.closeMenu();\n  };\n  containerRef = React.createRef<HTMLDivElement>();\n  componentDidMount() {\n    this.setState({ containerWidth: this.containerRef.current?.offsetWidth });\n  }\n  render() {\n    return (\n      <div\n        ref={this.containerRef}\n        className={classes.reactionMenuContainer}\n        style={{\n          top: this.props.yPosition - 9,\n          left: this.props.xPosition - this.state.containerWidth - 35,\n        }}\n      >\n        {reactionEmojis.map((reaction) => (\n          <div\n            onClick={() => {\n              this.props.handleReactionClick(reaction);\n              this.props.closeMenu();\n            }}\n            style={{ cursor: 'pointer' }}\n          >\n            {reaction}\n          </div>\n        ))}\n      </div>\n    );\n  }\n}\nconst ReactionMenu = onClickOutside(ReactionMenuInner);\n"]},"metadata":{},"sourceType":"module"}