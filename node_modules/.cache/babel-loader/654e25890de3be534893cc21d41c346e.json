{"ast":null,"code":"import _objectWithoutProperties from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _createForOfIteratorHelper from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _asyncToGenerator from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _objectSpread from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createSuper.js\";var _excluded=[\"event\"];var _EVENT$MESSAGE;import _regeneratorRuntime from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/regenerator/index.js\";import EventEmitter from'eventemitter3';// import { iceServers } from '../../utils';\nimport{OPCODE}from'./data';import{EVENT}from'./events';_EVENT$MESSAGE=EVENT.MESSAGE;// export interface BaseEvents {\n//   info: (...message: any[]) => void;\n//   warn: (...message: any[]) => void;\n//   debug: (...message: any[]) => void;\n//   error: (error: Error) => void;\n// }\nexport var BaseClient=/*#__PURE__*/function(_EventEmitter){_inherits(BaseClient,_EventEmitter);var _super=_createSuper(BaseClient);function BaseClient(){var _this;_classCallCheck(this,BaseClient);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this._ws=void 0;_this._peer=void 0;_this._channel=void 0;_this._timeout=void 0;_this._displayname=void 0;_this._state='disconnected';_this._id='';_this._candidates=[];return _this;}_createClass(BaseClient,[{key:\"id\",get:function get(){return this._id;}},{key:\"supported\",get:function get(){return typeof RTCPeerConnection!=='undefined'&&typeof RTCPeerConnection.prototype.addTransceiver!=='undefined';}},{key:\"socketOpen\",get:function get(){return typeof this._ws!=='undefined'&&this._ws.readyState===WebSocket.OPEN;}},{key:\"peerConnected\",get:function get(){return typeof this._peer!=='undefined'&&['connected','checking','completed'].includes(this._state);}},{key:\"connected\",get:function get(){return this.peerConnected&&this.socketOpen;}},{key:\"connect\",value:function connect(url,password,displayname){var _this2=this;if(this.socketOpen){this.emit('warn',\"attempting to create websocket while connection open\");return;}if(!this.supported){this.onDisconnected(new Error('browser does not support webrtc (RTCPeerConnection missing)'));return;}this._displayname=displayname;this[EVENT.CONNECTING]();try{this._ws=new WebSocket(\"\".concat(url,\"?password=\").concat(encodeURIComponent(password)));this.emit('debug',\"connecting to \".concat(this._ws.url));this._ws.onmessage=this.onMessage.bind(this);this._ws.onerror=function(event){return _this2.onError.bind(_this2);};this._ws.onclose=function(event){return _this2.onDisconnected.bind(_this2,new Error('websocket closed'));};this._timeout=window.setTimeout(this.onTimeout.bind(this),15000);}catch(err){this.onDisconnected(err);}}},{key:\"disconnect\",value:function disconnect(){if(this._timeout){clearTimeout(this._timeout);this._timeout=undefined;}if(this._ws){// reset all events\nthis._ws.onmessage=function(){};this._ws.onerror=function(){};this._ws.onclose=function(){};try{this._ws.close();}catch(err){}this._ws=undefined;}if(this._channel){// reset all events\nthis._channel.onmessage=function(){};this._channel.onerror=function(){};this._channel.onclose=function(){};try{this._channel.close();}catch(err){}this._channel=undefined;}if(this._peer){// reset all events\nthis._peer.onconnectionstatechange=function(){};this._peer.onsignalingstatechange=function(){};this._peer.oniceconnectionstatechange=function(){};this._peer.ontrack=function(){};try{this._peer.close();}catch(err){}this._peer=undefined;}this._state='disconnected';this._displayname=undefined;this._id='';}},{key:\"sendData\",value:function sendData(event,data){if(!this.connected){this.emit('warn',\"attempting to send data while disconnected\");return;}var buffer=undefined;var payload;switch(event){case'mousemove':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.MOVE);payload.setUint16(1,4,true);payload.setUint16(3,data.x,true);payload.setUint16(5,data.y,true);break;case'wheel':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.SCROLL);payload.setUint16(1,4,true);payload.setInt16(3,data.x,true);payload.setInt16(5,data.y,true);break;case'keydown':case'mousedown':buffer=new ArrayBuffer(11);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_DOWN);payload.setUint16(1,8,true);payload.setBigUint64(3,BigInt(data.key),true);break;case'keyup':case'mouseup':buffer=new ArrayBuffer(11);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_UP);payload.setUint16(1,8,true);payload.setBigUint64(3,BigInt(data.key),true);break;default:this.emit('warn',\"unknown data event: \".concat(event));}if(buffer){this._channel.send(buffer);}}},{key:\"sendMessage\",value:function sendMessage(event,payload){if(!this.connected){this.emit('warn',\"attempting to send message while disconnected\");return;}this.emit('debug',\"sending event '\".concat(event,\"' \").concat(payload?\"with payload: \":''),payload);this._ws.send(JSON.stringify(_objectSpread({event:event},payload)));}},{key:\"createPeer\",value:function(){var _createPeer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(lite,servers){var _this3=this;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.emit('debug',\"creating peer\");if(this.socketOpen){_context2.next=4;break;}this.emit('warn',\"attempting to create peer with no websocket: \",this._ws?\"state: \".concat(this._ws.readyState):'no socket');return _context2.abrupt(\"return\");case 4:if(!this.peerConnected){_context2.next=7;break;}this.emit('warn',\"attempting to create peer while connected\");return _context2.abrupt(\"return\");case 7:this._peer=new RTCPeerConnection();if(lite!==true){this._peer=new RTCPeerConnection({iceServers:servers});}this._peer.onconnectionstatechange=function(event){_this3.emit('debug',\"peer connection state changed\",_this3._peer?_this3._peer.connectionState:undefined);};this._peer.onsignalingstatechange=function(event){_this3.emit('debug',\"peer signaling state changed\",_this3._peer?_this3._peer.signalingState:undefined);};this._peer.oniceconnectionstatechange=function(event){_this3._state=_this3._peer.iceConnectionState;_this3.emit('debug',\"peer ice connection state changed: \".concat(_this3._peer.iceConnectionState));switch(_this3._state){case'checking':if(_this3._timeout){clearTimeout(_this3._timeout);_this3._timeout=undefined;}break;case'connected':_this3.onConnected();break;case'disconnected':_this3[EVENT.RECONNECTING]();break;// https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling#ice_connection_state\n// We don't watch the disconnected signaling state here as it can indicate temporary issues and may\n// go back to a connected state after some time. Watching it would close the video call on any temporary\n// network issue.\ncase'failed':_this3.onDisconnected(new Error('peer failed'));break;case'closed':_this3.onDisconnected(new Error('peer closed'));break;}};this._peer.ontrack=this.onTrack.bind(this);this._peer.onnegotiationneeded=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var d;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this3.emit('warn',\"negotiation is needed\");_context.next=3;return _this3._peer.createOffer();case 3:d=_context.sent;_this3._peer.setLocalDescription(d);_this3._ws.send(JSON.stringify({event:EVENT.SIGNAL.OFFER,sdp:d.sdp}));case 6:case\"end\":return _context.stop();}}},_callee);}));this._channel=this._peer.createDataChannel('data');this._channel.onerror=this.onError.bind(this);this._channel.onmessage=this.onData.bind(this);this._channel.onclose=this.onDisconnected.bind(this,new Error('peer data channel closed'));case 18:case\"end\":return _context2.stop();}}},_callee2,this);}));function createPeer(_x,_x2){return _createPeer.apply(this,arguments);}return createPeer;}()},{key:\"setRemoteOffer\",value:function(){var _setRemoteOffer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(sdp){var _iterator,_step,candidate,d;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(this._peer){_context3.next=3;break;}this.emit('warn',\"attempting to set remote offer while disconnected\");return _context3.abrupt(\"return\");case 3:this._peer.setRemoteDescription({type:'offer',sdp:sdp});_iterator=_createForOfIteratorHelper(this._candidates);try{for(_iterator.s();!(_step=_iterator.n()).done;){candidate=_step.value;this._peer.addIceCandidate(candidate);}}catch(err){_iterator.e(err);}finally{_iterator.f();}this._candidates=[];_context3.prev=7;_context3.next=10;return this._peer.createAnswer();case 10:d=_context3.sent;this._peer.setLocalDescription(d);this._ws.send(JSON.stringify({event:EVENT.SIGNAL.ANSWER,sdp:d.sdp,displayname:this._displayname}));_context3.next=18;break;case 15:_context3.prev=15;_context3.t0=_context3[\"catch\"](7);this.emit('error',_context3.t0);case 18:case\"end\":return _context3.stop();}}},_callee3,this,[[7,15]]);}));function setRemoteOffer(_x3){return _setRemoteOffer.apply(this,arguments);}return setRemoteOffer;}()},{key:\"setRemoteAnswer\",value:function(){var _setRemoteAnswer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(sdp){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(this._peer){_context4.next=3;break;}this.emit('warn',\"attempting to set remote answer while disconnected\");return _context4.abrupt(\"return\");case 3:this._peer.setRemoteDescription({type:'answer',sdp:sdp});case 4:case\"end\":return _context4.stop();}}},_callee4,this);}));function setRemoteAnswer(_x4){return _setRemoteAnswer.apply(this,arguments);}return setRemoteAnswer;}()},{key:\"onMessage\",value:function(){var _onMessage=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(e){var _ref2,event,payload,_ref3,sdp,lite,ice,id,_ref4,_sdp,_ref5,_sdp2,_ref6,_data,candidate;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_ref2=JSON.parse(e.data),event=_ref2.event,payload=_objectWithoutProperties(_ref2,_excluded);this.emit('debug',\"received websocket event \".concat(event,\" \").concat(payload?\"with payload: \":''),payload);if(!(event===EVENT.SIGNAL.PROVIDE)){_context5.next=10;break;}_ref3=payload,sdp=_ref3.sdp,lite=_ref3.lite,ice=_ref3.ice,id=_ref3.id;this._id=id;_context5.next=7;return this.createPeer(lite,ice);case 7:_context5.next=9;return this.setRemoteOffer(sdp);case 9:return _context5.abrupt(\"return\");case 10:if(!(event===EVENT.SIGNAL.OFFER)){_context5.next=15;break;}_ref4=payload,_sdp=_ref4.sdp;_context5.next=14;return this.setRemoteOffer(_sdp);case 14:return _context5.abrupt(\"return\");case 15:if(!(event===EVENT.SIGNAL.ANSWER)){_context5.next=20;break;}_ref5=payload,_sdp2=_ref5.sdp;_context5.next=19;return this.setRemoteAnswer(_sdp2);case 19:return _context5.abrupt(\"return\");case 20:if(!(event===EVENT.SIGNAL.CANDIDATE)){_context5.next=25;break;}_ref6=payload,_data=_ref6.data;candidate=JSON.parse(_data);if(this._peer){this._peer.addIceCandidate(candidate);}else{this._candidates.push(candidate);}return _context5.abrupt(\"return\");case 25:// @ts-ignore\nif(typeof this[event]==='function'){// @ts-ignore\nthis[event](payload);}else{this[EVENT.MESSAGE](event,payload);}case 26:case\"end\":return _context5.stop();}}},_callee5,this);}));function onMessage(_x5){return _onMessage.apply(this,arguments);}return onMessage;}()},{key:\"onData\",value:function onData(e){this[EVENT.DATA](e.data);}},{key:\"onTrack\",value:function onTrack(event){this.emit('debug',\"received \".concat(event.track.kind,\" track from peer: \").concat(event.track.id),event);var stream=event.streams[0];if(!stream){this.emit('warn',\"no stream provided for track \".concat(event.track.id,\"(\").concat(event.track.label,\")\"));return;}this[EVENT.TRACK](event);}},{key:\"onError\",value:function onError(event){this.emit('error',event.error);}},{key:\"onConnected\",value:function onConnected(){if(this._timeout){clearTimeout(this._timeout);this._timeout=undefined;}if(!this.connected){this.emit('warn',\"onConnected called while being disconnected\");return;}this.emit('debug',\"connected\");this[EVENT.CONNECTED]();}},{key:\"onTimeout\",value:function onTimeout(){this.emit('debug',\"connection timeout\");if(this._timeout){clearTimeout(this._timeout);this._timeout=undefined;}this.onDisconnected(new Error('connection timeout'));}},{key:\"onDisconnected\",value:function onDisconnected(reason){this.disconnect();this.emit('debug',\"disconnected:\",reason);this[EVENT.DISCONNECTED](reason);}},{key:_EVENT$MESSAGE,value:function value(event,payload){this.emit('warn',\"unhandled websocket event '\".concat(event,\"':\"),payload);}}]);return BaseClient;}(EventEmitter);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/VBrowser/base.ts"],"names":["EventEmitter","OPCODE","EVENT","MESSAGE","BaseClient","_ws","_peer","_channel","_timeout","_displayname","_state","_id","_candidates","RTCPeerConnection","prototype","addTransceiver","readyState","WebSocket","OPEN","includes","peerConnected","socketOpen","url","password","displayname","emit","supported","onDisconnected","Error","CONNECTING","encodeURIComponent","onmessage","onMessage","bind","onerror","event","onError","onclose","window","setTimeout","onTimeout","err","clearTimeout","undefined","close","onconnectionstatechange","onsignalingstatechange","oniceconnectionstatechange","ontrack","data","connected","buffer","payload","ArrayBuffer","DataView","setUint8","MOVE","setUint16","x","y","SCROLL","setInt16","KEY_DOWN","setBigUint64","BigInt","key","KEY_UP","send","JSON","stringify","lite","servers","iceServers","connectionState","signalingState","iceConnectionState","onConnected","RECONNECTING","onTrack","onnegotiationneeded","createOffer","d","setLocalDescription","SIGNAL","OFFER","sdp","createDataChannel","onData","setRemoteDescription","type","candidate","addIceCandidate","createAnswer","ANSWER","e","parse","PROVIDE","ice","id","createPeer","setRemoteOffer","setRemoteAnswer","CANDIDATE","push","DATA","track","kind","stream","streams","label","TRACK","error","CONNECTED","reason","disconnect","DISCONNECTED"],"mappings":"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","sourcesContent":["import EventEmitter from 'eventemitter3';\n\n// import { iceServers } from '../../utils';\nimport { OPCODE } from './data';\nimport { EVENT, WebSocketEvents } from './events';\nimport {\n  WebSocketMessages,\n  WebSocketPayloads,\n  SignalProvidePayload,\n  SignalCandidatePayload,\n  SignalOfferPayload,\n  SignalAnswerMessage,\n} from './messages';\n\n// export interface BaseEvents {\n//   info: (...message: any[]) => void;\n//   warn: (...message: any[]) => void;\n//   debug: (...message: any[]) => void;\n//   error: (error: Error) => void;\n// }\n\nexport abstract class BaseClient extends EventEmitter<any> {\n  protected _ws?: WebSocket;\n  protected _peer?: RTCPeerConnection;\n  protected _channel?: RTCDataChannel;\n  protected _timeout?: number;\n  protected _displayname?: string;\n  protected _state: RTCIceConnectionState = 'disconnected';\n  protected _id = '';\n  protected _candidates: RTCIceCandidate[] = [];\n\n  get id() {\n    return this._id;\n  }\n\n  get supported() {\n    return (\n      typeof RTCPeerConnection !== 'undefined' &&\n      typeof RTCPeerConnection.prototype.addTransceiver !== 'undefined'\n    );\n  }\n\n  get socketOpen() {\n    return (\n      typeof this._ws !== 'undefined' && this._ws.readyState === WebSocket.OPEN\n    );\n  }\n\n  get peerConnected() {\n    return (\n      typeof this._peer !== 'undefined' &&\n      ['connected', 'checking', 'completed'].includes(this._state)\n    );\n  }\n\n  get connected() {\n    return this.peerConnected && this.socketOpen;\n  }\n\n  public connect(url: string, password: string, displayname: string) {\n    if (this.socketOpen) {\n      this.emit('warn', `attempting to create websocket while connection open`);\n      return;\n    }\n\n    if (!this.supported) {\n      this.onDisconnected(\n        new Error('browser does not support webrtc (RTCPeerConnection missing)')\n      );\n      return;\n    }\n\n    this._displayname = displayname;\n    this[EVENT.CONNECTING]();\n\n    try {\n      this._ws = new WebSocket(\n        `${url}?password=${encodeURIComponent(password)}`\n      );\n      this.emit('debug', `connecting to ${this._ws.url}`);\n      this._ws.onmessage = this.onMessage.bind(this);\n      this._ws.onerror = (event) => this.onError.bind(this);\n      this._ws.onclose = (event) =>\n        this.onDisconnected.bind(this, new Error('websocket closed'));\n      this._timeout = window.setTimeout(this.onTimeout.bind(this), 15000);\n    } catch (err: any) {\n      this.onDisconnected(err);\n    }\n  }\n\n  protected disconnect() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n      this._timeout = undefined;\n    }\n\n    if (this._ws) {\n      // reset all events\n      this._ws.onmessage = () => {};\n      this._ws.onerror = () => {};\n      this._ws.onclose = () => {};\n\n      try {\n        this._ws.close();\n      } catch (err) {}\n\n      this._ws = undefined;\n    }\n\n    if (this._channel) {\n      // reset all events\n      this._channel.onmessage = () => {};\n      this._channel.onerror = () => {};\n      this._channel.onclose = () => {};\n\n      try {\n        this._channel.close();\n      } catch (err) {}\n\n      this._channel = undefined;\n    }\n\n    if (this._peer) {\n      // reset all events\n      this._peer.onconnectionstatechange = () => {};\n      this._peer.onsignalingstatechange = () => {};\n      this._peer.oniceconnectionstatechange = () => {};\n      this._peer.ontrack = () => {};\n\n      try {\n        this._peer.close();\n      } catch (err) {}\n\n      this._peer = undefined;\n    }\n\n    this._state = 'disconnected';\n    this._displayname = undefined;\n    this._id = '';\n  }\n\n  public sendData(\n    event: 'wheel' | 'mousemove',\n    data: { x: number; y: number }\n  ): void;\n  public sendData(\n    event: 'mousedown' | 'mouseup' | 'keydown' | 'keyup',\n    data: { key: number }\n  ): void;\n  public sendData(event: string, data: any) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send data while disconnected`);\n      return;\n    }\n\n    let buffer: ArrayBuffer | undefined = undefined;\n    let payload: DataView;\n    switch (event) {\n      case 'mousemove':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.MOVE);\n        payload.setUint16(1, 4, true);\n        payload.setUint16(3, data.x, true);\n        payload.setUint16(5, data.y, true);\n        break;\n      case 'wheel':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.SCROLL);\n        payload.setUint16(1, 4, true);\n        payload.setInt16(3, data.x, true);\n        payload.setInt16(5, data.y, true);\n        break;\n      case 'keydown':\n      case 'mousedown':\n        buffer = new ArrayBuffer(11);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_DOWN);\n        payload.setUint16(1, 8, true);\n        payload.setBigUint64(3, BigInt(data.key), true);\n        break;\n      case 'keyup':\n      case 'mouseup':\n        buffer = new ArrayBuffer(11);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_UP);\n        payload.setUint16(1, 8, true);\n        payload.setBigUint64(3, BigInt(data.key), true);\n        break;\n      default:\n        this.emit('warn', `unknown data event: ${event}`);\n    }\n\n    if (buffer) {\n      this._channel!.send(buffer);\n    }\n  }\n\n  public sendMessage(event: WebSocketEvents, payload?: WebSocketPayloads) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send message while disconnected`);\n      return;\n    }\n    this.emit(\n      'debug',\n      `sending event '${event}' ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n    this._ws!.send(JSON.stringify({ event, ...payload }));\n  }\n\n  public async createPeer(lite: boolean, servers: RTCIceServer[]) {\n    this.emit('debug', `creating peer`);\n    if (!this.socketOpen) {\n      this.emit(\n        'warn',\n        `attempting to create peer with no websocket: `,\n        this._ws ? `state: ${this._ws.readyState}` : 'no socket'\n      );\n      return;\n    }\n\n    if (this.peerConnected) {\n      this.emit('warn', `attempting to create peer while connected`);\n      return;\n    }\n\n    this._peer = new RTCPeerConnection();\n    if (lite !== true) {\n      this._peer = new RTCPeerConnection({\n        iceServers: servers,\n      });\n    }\n\n    this._peer.onconnectionstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer connection state changed`,\n        this._peer ? this._peer.connectionState : undefined\n      );\n    };\n\n    this._peer.onsignalingstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer signaling state changed`,\n        this._peer ? this._peer.signalingState : undefined\n      );\n    };\n\n    this._peer.oniceconnectionstatechange = (event) => {\n      this._state = this._peer!.iceConnectionState;\n\n      this.emit(\n        'debug',\n        `peer ice connection state changed: ${this._peer!.iceConnectionState}`\n      );\n\n      switch (this._state) {\n        case 'checking':\n          if (this._timeout) {\n            clearTimeout(this._timeout);\n            this._timeout = undefined;\n          }\n          break;\n        case 'connected':\n          this.onConnected();\n          break;\n        case 'disconnected':\n          this[EVENT.RECONNECTING]();\n          break;\n        // https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling#ice_connection_state\n        // We don't watch the disconnected signaling state here as it can indicate temporary issues and may\n        // go back to a connected state after some time. Watching it would close the video call on any temporary\n        // network issue.\n        case 'failed':\n          this.onDisconnected(new Error('peer failed'));\n          break;\n        case 'closed':\n          this.onDisconnected(new Error('peer closed'));\n          break;\n      }\n    };\n\n    this._peer.ontrack = this.onTrack.bind(this);\n\n    this._peer.onnegotiationneeded = async () => {\n      this.emit('warn', `negotiation is needed`);\n\n      const d = await this._peer!.createOffer();\n      this._peer!.setLocalDescription(d);\n\n      this._ws!.send(\n        JSON.stringify({\n          event: EVENT.SIGNAL.OFFER,\n          sdp: d.sdp,\n        })\n      );\n    };\n\n    this._channel = this._peer.createDataChannel('data');\n    this._channel.onerror = this.onError.bind(this);\n    this._channel.onmessage = this.onData.bind(this);\n    this._channel.onclose = this.onDisconnected.bind(\n      this,\n      new Error('peer data channel closed')\n    );\n  }\n\n  public async setRemoteOffer(sdp: string) {\n    if (!this._peer) {\n      this.emit('warn', `attempting to set remote offer while disconnected`);\n      return;\n    }\n\n    this._peer.setRemoteDescription({ type: 'offer', sdp });\n\n    for (const candidate of this._candidates) {\n      this._peer.addIceCandidate(candidate);\n    }\n    this._candidates = [];\n\n    try {\n      const d = await this._peer.createAnswer();\n      this._peer!.setLocalDescription(d);\n\n      this._ws!.send(\n        JSON.stringify({\n          event: EVENT.SIGNAL.ANSWER,\n          sdp: d.sdp,\n          displayname: this._displayname,\n        })\n      );\n    } catch (err: any) {\n      this.emit('error', err);\n    }\n  }\n\n  public async setRemoteAnswer(sdp: string) {\n    if (!this._peer) {\n      this.emit('warn', `attempting to set remote answer while disconnected`);\n      return;\n    }\n\n    this._peer.setRemoteDescription({ type: 'answer', sdp });\n  }\n\n  private async onMessage(e: MessageEvent) {\n    const { event, ...payload } = JSON.parse(e.data) as WebSocketMessages;\n\n    this.emit(\n      'debug',\n      `received websocket event ${event} ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n\n    if (event === EVENT.SIGNAL.PROVIDE) {\n      const { sdp, lite, ice, id } = payload as SignalProvidePayload;\n      this._id = id;\n      await this.createPeer(lite, ice);\n      await this.setRemoteOffer(sdp);\n      return;\n    }\n\n    if (event === EVENT.SIGNAL.OFFER) {\n      const { sdp } = payload as SignalOfferPayload;\n      await this.setRemoteOffer(sdp);\n      return;\n    }\n\n    if (event === EVENT.SIGNAL.ANSWER) {\n      const { sdp } = payload as SignalAnswerMessage;\n      await this.setRemoteAnswer(sdp);\n      return;\n    }\n\n    if (event === EVENT.SIGNAL.CANDIDATE) {\n      const { data } = payload as SignalCandidatePayload;\n      const candidate: RTCIceCandidate = JSON.parse(data);\n      if (this._peer) {\n        this._peer.addIceCandidate(candidate);\n      } else {\n        this._candidates.push(candidate);\n      }\n      return;\n    }\n\n    // @ts-ignore\n    if (typeof this[event] === 'function') {\n      // @ts-ignore\n      this[event](payload);\n    } else {\n      this[EVENT.MESSAGE](event, payload);\n    }\n  }\n\n  private onData(e: MessageEvent) {\n    this[EVENT.DATA](e.data);\n  }\n\n  private onTrack(event: RTCTrackEvent) {\n    this.emit(\n      'debug',\n      `received ${event.track.kind} track from peer: ${event.track.id}`,\n      event\n    );\n    const stream = event.streams[0];\n    if (!stream) {\n      this.emit(\n        'warn',\n        `no stream provided for track ${event.track.id}(${event.track.label})`\n      );\n      return;\n    }\n    this[EVENT.TRACK](event);\n  }\n\n  private onError(event: Event) {\n    this.emit('error', (event as ErrorEvent).error);\n  }\n\n  private onConnected() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n      this._timeout = undefined;\n    }\n\n    if (!this.connected) {\n      this.emit('warn', `onConnected called while being disconnected`);\n      return;\n    }\n\n    this.emit('debug', `connected`);\n    this[EVENT.CONNECTED]();\n  }\n\n  private onTimeout() {\n    this.emit('debug', `connection timeout`);\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n      this._timeout = undefined;\n    }\n    this.onDisconnected(new Error('connection timeout'));\n  }\n\n  protected onDisconnected(reason?: Error) {\n    this.disconnect();\n    this.emit('debug', `disconnected:`, reason);\n    this[EVENT.DISCONNECTED](reason);\n  }\n\n  protected [EVENT.MESSAGE](event: string, payload: any) {\n    this.emit('warn', `unhandled websocket event '${event}':`, payload);\n  }\n\n  protected abstract [EVENT.RECONNECTING](): void;\n  protected abstract [EVENT.CONNECTING](): void;\n  protected abstract [EVENT.CONNECTED](): void;\n  protected abstract [EVENT.DISCONNECTED](reason?: Error): void;\n  protected abstract [EVENT.TRACK](event: RTCTrackEvent): void;\n  protected abstract [EVENT.DATA](data: any): void;\n}\n"]},"metadata":{},"sourceType":"module"}